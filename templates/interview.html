<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InJob - 모의 면접</title>
    <link rel="stylesheet" href="/static/interview.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <img src="/static/inje_logo.jpg" alt="인제대학교 로고" class="inje-logo">
                    <div class="logo">InJob</div>
                </div>
                <div class="subtitle">모의 면접</div>
            </div>
        </div>
    </header>

    <main>
        <div class="interview-container">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">모의 면접 설정</h2>
                    <p class="card-subtitle">지원하는 직무와 면접 유형을 선택해주세요</p>
                </div>
                <div class="card-body">
                    <form id="interview-form" method="post" onsubmit="startInterview(event)">
                        <div class="form-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                지원 분야
                            </h3>
                            <div class="field-container">
                                <select id="job-field" name="job_field" class="select-field">
                                    <option value="" disabled selected>지원하려는 직무를 선택하세요</option>
                                    <option value="개발">개발</option>
                                    <option value="기획">기획</option>
                                    <option value="디자인">디자인</option>
                                    <option value="마케팅">마케팅</option>
                                    <option value="영업">영업</option>
                                    <option value="연구">연구</option>
                                    <option value="인사">인사</option>
                                    <option value="재무">재무</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                면접 유형
                            </h3>
                            <div class="interview-type-options">
                                <label class="type-option">
                                    <input type="radio" name="interview_type" value="basic">
                                    <div class="type-content">
                                        <div class="type-header">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="8" y1="12" x2="16" y2="12"></line>
                                                <line x1="8" y1="16" x2="16" y2="16"></line>
                                                <line x1="8" y1="8" x2="16" y2="8"></line>
                                            </svg>
                                            <span>기본 면접</span>
                                        </div>
                                        <p>직무 관련 기본적인 질문들로 구성됩니다.</p>
                                    </div>
                                </label>

                                <label class="type-option">
                                    <input type="radio" name="interview_type" value="behavioral">
                                    <div class="type-content">
                                        <div class="type-header">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <path
                                                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                                </path>
                                            </svg>
                                            <span>경험 기반 면접</span>
                                        </div>
                                        <p>과거 경험과 상황 대처 방식에 관한 질문들로 구성됩니다.</p>
                                    </div>
                                </label>

                                <label class="type-option">
                                    <input type="radio" name="interview_type" value="technical" checked>
                                    <div class="type-content">
                                        <div class="type-header">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <polyline points="16 18 22 12 16 6"></polyline>
                                                <polyline points="8 6 2 12 8 18"></polyline>
                                            </svg>
                                            <span>기술 면접</span>
                                        </div>
                                        <p>직무 관련 기술적 지식을 평가하는 질문들로 구성됩니다.</p>
                                    </div>
                                </label>

                                <label class="type-option">
                                    <input type="radio" name="interview_type" value="stress">
                                    <div class="type-content">
                                        <div class="type-header">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                            </svg>
                                            <span>압박 면접</span>
                                        </div>
                                        <p>스트레스 상황에서의 대응력을 평가하는 질문들로 구성됩니다.</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                                    <path
                                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z" />
                                </svg>
                                추가 옵션
                            </h3>
                            <div class="additional-options">
                                <label class="checkbox-option">
                                    <input type="checkbox" name="feedback" value="true" checked>
                                    <span>답변 피드백 받기</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" name="record" value="true">
                                    <span>면접 내용 기록하기</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" name="tips" value="true" checked>
                                    <span>면접 팁 제공받기</span>
                                </label>
                            </div>
                        </div>

                        <div class="action-row" style="display: flex; justify-content: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary action-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="8.5" cy="7" r="4"></circle>
                                    <line x1="20" y1="8" x2="20" y2="14"></line>
                                    <line x1="23" y1="11" x2="17" y2="11"></line>
                                </svg>
                                면접 시작하기
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card interview-result">
                <div class="card-header">
                    <h2 class="card-title">면접 대화</h2>
                    <p class="card-subtitle">면접관과의 대화가 이곳에 표시됩니다</p>
                </div>
                <div class="card-body">
                    <div id="result-content" class="result-content empty">
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <h3>모의면접 준비 완료</h3>
                            <p>왼쪽에서 면접 옵션을 선택하고 면접 시작하기 버튼을 눌러주세요.</p>
                        </div>
                    </div>

                    <div id="interview-active" class="interview-active" style="display: none;">
                        <div class="interview-messages">
                            <!-- 메시지들이 여기에 추가됩니다 -->
                        </div>

                        <div class="interview-input">
                            <textarea id="answer-input" placeholder="답변을 입력하세요..."></textarea>
                            <button id="send-answer" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="loading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>AI 면접관이 질문을 준비하고 있습니다...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <a href="/" class="back-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            홈으로 돌아가기
        </a>
    </footer>

    <script>
        // 세션 ID를 저장할 변수
        let currentSessionId = null;

        async function startInterview(event) {
            event.preventDefault();

            const jobField = document.getElementById('job-field').value;
            if (!jobField) {
                alert('지원 분야를 선택해주세요.');
                return;
            }

            const loadingElement = document.getElementById('loading');
            const resultContent = document.getElementById('result-content');
            const interviewActive = document.getElementById('interview-active');

            // 로딩 표시, 결과 숨김
            loadingElement.style.display = 'flex';
            resultContent.style.display = 'none';

            // 폼 데이터 수집
            const form = document.getElementById('interview-form');
            const formData = new FormData(form);

            try {
                const response = await fetch('/interview/start', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    // 세션 ID 저장
                    currentSessionId = result.session_id;
                    console.log("세션 ID:", currentSessionId);

                    loadingElement.style.display = 'none';
                    resultContent.style.display = 'none';
                    interviewActive.style.display = 'flex';

                    // 첫 질문 추가
                    addMessage('interviewer', result.first_question);

                    // 면접 종료 버튼 추가
                    addEndInterviewButton();
                } else {
                    throw new Error('서버 응답 오류');
                }
            } catch (error) {
                loadingElement.style.display = 'none';
                resultContent.style.display = 'block';
                resultContent.innerHTML = '<p>면접 준비 중 오류가 발생했어요. 다시 시도해 주세요!</p>';
                console.error(error);
            }
        }

        function addMessage(sender, text) {
            const messagesContainer = document.querySelector('.interview-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            const iconSvg = sender === 'interviewer'
                ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';

            messageDiv.innerHTML = `
        <div class="message-avatar">${iconSvg}</div>
        <div class="message-content">
            <div class="message-sender">${sender === 'interviewer' ? 'AI 면접관' : '나'}</div>
            <div class="message-text">${text}</div>
        </div>
    `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 답변 보내기 버튼 이벤트
        document.getElementById('send-answer').addEventListener('click', async function () {
            const answerInput = document.getElementById('answer-input');
            const answer = answerInput.value.trim();

            if (!answer) return;

            // 세션 ID 확인
            if (!currentSessionId) {
                alert('면접 세션이 유효하지 않습니다. 다시 시작해주세요.');
                return;
            }

            // 사용자 답변 추가
            addMessage('user', answer);
            answerInput.value = '';

            // 로딩 표시
            const messagesContainer = document.querySelector('.interview-messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message-loading';
            loadingDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                // 서버에 답변 전송 및 다음 질문 받기
                const response = await fetch('/interview/answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        answer: answer,
                        session_id: currentSessionId // 세션 ID 포함
                    })
                });

                // 로딩 제거
                messagesContainer.removeChild(loadingDiv);

                if (response.ok) {
                    const result = await response.json();

                    // 피드백 있으면 추가
                    if (result.feedback) {
                        const feedbackDiv = document.createElement('div');
                        feedbackDiv.className = 'message-feedback';
                        feedbackDiv.innerHTML = `
                    <div class="feedback-header">답변 피드백</div>
                    <div class="feedback-content">${result.feedback}</div>
                `;
                        messagesContainer.appendChild(feedbackDiv);
                    }

                    // 다음 질문 추가
                    setTimeout(() => {
                        addMessage('interviewer', result.next_question);
                    }, 500);
                } else {
                    throw new Error('서버 응답 오류');
                }
            } catch (error) {
                console.error('답변 전송 오류:', error);
                // 로딩 제거 (오류 발생 시)
                if (messagesContainer.contains(loadingDiv)) {
                    messagesContainer.removeChild(loadingDiv);
                }

                // 오류 메시지 추가
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message-error';
                errorDiv.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
                messagesContainer.appendChild(errorDiv);
            }
        });

        // 면접 종료 버튼 추가
        function addEndInterviewButton() {
            const interviewActive = document.getElementById('interview-active');

            // 이미 버튼이 있으면 추가하지 않음
            if (document.getElementById('end-interview-btn')) return;

            const endButtonContainer = document.createElement('div');
            endButtonContainer.className = 'end-interview-container';

            const endButton = document.createElement('button');
            endButton.id = 'end-interview-btn';
            endButton.className = 'btn btn-secondary';
            endButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="9" x2="15" y2="15"></line>
            <line x1="15" y1="9" x2="9" y2="15"></line>
        </svg>
        면접 종료하기
    `;

            endButton.addEventListener('click', endInterview);
            endButtonContainer.appendChild(endButton);

            // 메시지 입력창 위에 추가
            const inputContainer = document.querySelector('.interview-input');
            inputContainer.parentNode.insertBefore(endButtonContainer, inputContainer);
        }

        function formatSummaryToHTML(markdownText) {
            // 헤더 처리 (###, ##, #)
            let htmlText = markdownText
                .replace(/### (.*?)\n/g, '<h3>$1</h3>\n')
                .replace(/## (.*?)\n/g, '<h2>$1</h2>\n')
                .replace(/# (.*?)\n/g, '<h1>$1</h1>\n');

            // 볼드 처리 (**text**)
            htmlText = htmlText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 이탤릭 처리 (*text*)
            htmlText = htmlText.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // 리스트 처리
            // 번호 있는 리스트
            htmlText = htmlText.replace(/(\d+)\. (.*?)(\n|$)/g, '<li>$2</li>');

            // 번호 없는 리스트 (-, *)
            htmlText = htmlText.replace(/- (.*?)(\n|$)/g, '<li>$1</li>');
            htmlText = htmlText.replace(/\* (.*?)(\n|$)/g, '<li>$1</li>');

            // 줄바꿈 처리
            htmlText = htmlText.replace(/\n\n/g, '</p><p>');
            htmlText = htmlText.replace(/\n/g, '<br>');

            // 여러 개의 리스트 아이템을 <ul> 또는 <ol>로 감싸기
            htmlText = htmlText.replace(/<li>(.*?)<\/li>(\s*<li>.*?<\/li>)+/g, function (match) {
                return '<ul>' + match + '</ul>';
            });

            // 구분선 처리 (---, ***)
            htmlText = htmlText.replace(/---+/g, '<hr>');
            htmlText = htmlText.replace(/\*\*\*+/g, '<hr>');

            // 단락 처리 (이중 줄바꿈으로 구분된 단락)
            if (!htmlText.startsWith('<p>')) {
                htmlText = '<p>' + htmlText;
            }
            if (!htmlText.endsWith('</p>')) {
                htmlText += '</p>';
            }

            return htmlText;
        }
        
        // 면접 종료 처리
        async function endInterview() {
            // 세션 ID 확인
            if (!currentSessionId) {
                alert('면접 세션이 유효하지 않습니다.');
                return;
            }

            // 사용자 확인
            if (!confirm('면접을 종료하시겠습니까?')) {
                return;
            }

            // UI 업데이트
            const interviewActive = document.getElementById('interview-active');
            interviewActive.style.display = 'none';

            const resultContent = document.getElementById('result-content');
            resultContent.innerHTML = `
        <div class="interview-ended">
            <h3>면접이 종료되었습니다</h3>
            <p>수고하셨습니다! 새로운 면접을 시작하려면 아래 버튼을 클릭하세요.</p>
            <button id="restart-btn" class="btn btn-primary">새 면접 시작하기</button>
        </div>
    `;
            resultContent.style.display = 'block';
            resultContent.classList.remove('empty');

            // 다시 시작 버튼 이벤트
            resultContent.querySelector('#restart-btn').addEventListener('click', () => {
                window.location.reload();
            });

            // 서버에 세션 종료 알림 (요약 없이 단순 정리)
            try {
                const formData = new FormData();
                formData.append('session_id', currentSessionId);
                await fetch('/interview/end', {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('세션 종료 중 오류:', error);
            }

            // 세션 ID 초기화
            currentSessionId = null;
        }

        // Enter 키로 답변 제출
        document.getElementById('answer-input').addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('send-answer').click();
            }
        });
    </script>
</body>

</html>